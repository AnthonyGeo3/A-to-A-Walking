<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="A to A">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <title>A to A Walking Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        
        /* Horizontal Bar Styles */
        .progress-bar-track {
            background-color: #e0e0e0;
            border: 1px solid #d1d5db;
            height: 40px;
            border-radius: 99px;
            position: relative;
            overflow: visible;
        }
        .progress-bar-fill-ant {
            background: linear-gradient(to right, #4ade80, #34d399);
            transition: width 0.8s ease;
            height: 100%;
            border-radius: 99px;
        }
        .progress-bar-fill-amy {
            background: linear-gradient(to right, #a855f7, #9333ea);
            transition: width 0.8s ease;
            height: 100%;
            border-radius: 99px;
        }
        .peer-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.8s ease;
            z-index: 20; /* Higher z-index to stay on top */
            width: 0; 
            height: 0; 
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
        }
        /* Triangle pointing up from bottom */
        .peer-marker.bottom {
            border-bottom-width: 12px;
            border-bottom-style: solid;
            top: auto;
            bottom: -6px;
            transform: translateX(-50%);
        }

        /* Passport Styles - Circular Stamps */
        .passport-bg {
            background-color: #fdf6e3;
            background-image: radial-gradient(#d3c9b1 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            border: 4px double #d3c9b1;
            min-height: 150px;
        }
        .stamp {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 3px double #8b7355; /* Ink color */
            background: rgba(255, 255, 255, 0.7); /* Slightly opaque to standout on paper */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            margin: auto;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stamp:hover {
            transform: scale(1.1) !important;
            z-index: 20;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stamp:nth-child(3n+1) { transform: rotate(-4deg); }
        .stamp:nth-child(3n+2) { transform: rotate(3deg); }
        .stamp:nth-child(3n+3) { transform: rotate(-2deg); }

        .log-entry { transition: background 0.2s; }
        .log-entry:hover { background-color: #f9fafb; }
        #map { z-index: 1; }
        
        /* Map Marker Colors via CSS Filter */
        .marker-icon-ant { filter: hue-rotate(260deg) saturate(3) brightness(0.8); } /* Green-ish shift */
        .marker-icon-amy { filter: hue-rotate(420deg) saturate(2) brightness(0.9); } /* Purple-ish shift */
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6">

        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">A to A Walking!</h1>
            <p class="text-gray-500 text-sm">Est. Oct 25</p>
        </div>

        <!-- Input Section -->
        <div class="bg-gray-50 p-4 rounded-xl shadow-inner mb-8">
            <h2 class="text-lg font-semibold text-center mb-3">Log Steps</h2>
            <div class="flex justify-center gap-4 mb-3" id="user-selector"></div>
            <form id="step-form" class="hidden flex flex-col sm:flex-row items-center justify-center gap-2">
                <input type="number" id="step-input" placeholder="0" class="w-24 text-center p-2 border rounded-lg" required min="1">
                <button type="submit" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Add</button>
            </form>
            <p id="feedback-message" class="text-center text-green-600 text-sm mt-2 h-4"></p>
        </div>

        <!-- Horizontal Progress Bars -->
        <div class="space-y-6 mb-8">
            <div id="ant-progress-row"></div>
            <div id="amy-progress-row"></div>
        </div>

        <!-- Stats -->
        <div class="border-t pt-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">Stats</h2>
                <select id="stats-filter" class="p-1 border rounded text-sm"></select>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-green-50 p-2 rounded border border-green-100">
                    <p class="text-[10px] uppercase font-bold text-green-700">Ant Avg / Pred</p>
                    <p class="text-green-600 font-bold"><span id="user1-avg-steps">0</span> / <span id="user1-predicted-steps">0</span></p>
                </div>
                <div class="bg-purple-50 p-2 rounded border border-purple-100">
                    <p class="text-[10px] uppercase font-bold text-purple-700">Amy Avg / Pred</p>
                    <p class="text-purple-600 font-bold"><span id="user2-avg-steps">0</span> / <span id="user2-predicted-steps">0</span></p>
                </div>
            </div>
        </div>

        <!-- Passport -->
        <div class="border-t pt-6 mb-8">
            <h2 class="text-xl font-bold text-center text-gray-700 mb-4">üõÇ Milestone Passport</h2>
            <div id="passport-container" class="passport-bg rounded-xl p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Stamps go here -->
            </div>
        </div>

        <!-- Stretch Goals -->
        <div class="border-t pt-6 mb-8">
            <h2 class="text-xl font-bold text-center mb-4">Stretch Goals</h2>
            <div id="stretch-goals-container" class="space-y-3"></div>
        </div>

        <!-- High Scores -->
        <div class="border-t pt-6 mb-8">
            <h2 class="text-xl font-bold text-center mb-4">Best Days üèÜ</h2>
            <div class="grid grid-cols-2 gap-4" id="highscore-container">
                <div id="user1-highscore"></div>
                <div id="user2-highscore"></div>
            </div>
        </div>

        <!-- Logs & Map -->
        <div class="border-t pt-6">
            <h2 class="text-xl font-bold text-center mb-4">Log & Map</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div id="user1-log" class="max-h-64 overflow-y-auto space-y-2"></div>
                <div id="user2-log" class="max-h-64 overflow-y-auto space-y-2"></div>
            </div>
            <div id="map" class="h-64 rounded-lg shadow-md"></div>
        </div>
    </div>

    <!-- Modals (Simplified markup) -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm relative">
            <h3 id="modal-title" class="text-lg font-bold mb-3"></h3>
            <div id="modal-content"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="modal-cancel" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
                <button id="modal-confirm" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ‚öôÔ∏è CHALLENGE DATA ---
        const USER_1_NAME = "Ant";
        const USER_2_NAME = "Amy";
        
        const MASTER_MILESTONES = [
            { steps: 8073, label: "Amy's Parents üè°", description: "Ants' to my parents' house! ‚ù§Ô∏è" }, 
            { steps: 37063, label: "Long Trek üö∂‚Äç‚ôÇÔ∏è", description: "Amy's long walk to her parents! üö∂‚Äç‚ôÄÔ∏è" }, 
            { steps: 54854, label: "Marathon üèÉ‚Äç‚ôÄÔ∏è", description: "That's a marathon! üèÉ‚Äç‚ôÇÔ∏è" },
            { steps: 130000, label: "Birmingham üèôÔ∏è", description: "Hello Birmingham! üèôÔ∏è" }, 
            { steps: 156000, label: "24h Walk üåô", description: "A full day of walking! ‚òÄÔ∏èüåô" }, 
            { steps: 227708, label: "Cardiff üêâ", description: "Welcome to Cardiff! üêâ" },
            { steps: 256100, label: "Ant's Parents üè†", description: "To my parents' place! üè†" }, 
            { steps: 283335, label: "Dublin üçÄ", description: "Top of the mornin', Dublin! üçÄ" }, 
            { steps: 342212, label: "London üíÇ", description: "London calling! üíÇ" },
            { steps: 418483, label: "Edinburgh üè∞", description: "Och aye, Edinburgh! üè∞" }, 
            { steps: 480597, label: "Chunnel üöá", description: "Channel Tunnel! üöá" }, 
            { steps: 520000, label: "ISS üõ∞Ô∏è", description: "We've walked to the ISS! üõ∞Ô∏è" },
            { steps: 537316, label: "Calais üá´üá∑", description: "Bonjour, Calais! üá´üá∑" }, 
            { steps: 616174, label: "Bruges üè∞", description: "Fairytale Bruges! üè∞" }, 
            { steps: 700167, label: "Amsterdam üö≤", description: "Hello Amsterdam! üö≤" },
            { steps: 731601, label: "Brussels üáßüá™", description: "Brussels Sprouts! üòÑ" }, 
            { steps: 751023, label: "Paris Border üóº", description: "The outskirts of Paris! ü•ê" }, 
            { steps: 784043, label: "Eiffel Tower! üéâ", description: "Eiffel Tower! We made it! üéâ" },
            { steps: 836859, label: "Long Walk üéûÔ∏è", description: "The Long Walk! üö∂‚Äç‚ôÇÔ∏èüëë" }, 
            { steps: 954265, label: "Dortmund ‚öΩ", description: "Goal! Dortmund! ‚öΩ" }, 
            { steps: 1092000, label: "Week Walk üóìÔ∏è", description: "A whole week of walking! üóìÔ∏è" },
            { steps: 1145118, label: "Berlin üêª", description: "Paris to Berlin! ü•ñüç∫" }, 
            { steps: 1259557, label: "UK Length üá¨üáß", description: "Length of the UK! üá¨üáß" }, 
            { steps: 1365312, label: "Copenhagen üßú‚Äç‚ôÄÔ∏è", description: "Wonderful Copenhagen! üßú‚Äç‚ôÄÔ∏è" },
            { steps: 1480427, label: "Oslo üá≥üá¥", description: "Greetings from Oslo! üá≥üá¥" }, 
            { steps: 1595568, label: "Milan üáÆüáπ", description: "Fashion capital Milan! üáÆüáπ" }, 
            { steps: 1716000, label: "¬£100M Line üí∞", description: "¬£100M in tenners, laid end to end! üí∞" },
            { steps: 1761643, label: "Barcelona ‚òÄÔ∏è", description: "Hola, Barcelona! ‚òÄÔ∏è" }, 
            { steps: 1913990, label: "Florence üé®", description: "Florence, city of art! üé®" }, 
            { steps: 2206035, label: "Rome üèõÔ∏è", description: "When in Rome... üèõÔ∏è" },
            { steps: 3437785, label: "Athens üá¨üá∑", description: "Ancient Athens! üá¨üá∑" }, 
            { steps: 3766100, label: "Mordor üåã", description: "Shire to Mordor! üåã" }, 
            { steps: 4469179, label: "Paphos üá®üáæ", description: "Paphos, Cyprus! üá®üáæ" }
        ];
        const SHARED_STRETCH = [{ steps: 1000000, label: "Disneyland!", reward: "üè∞" }];
        const INDIVIDUAL_STRETCH = { user1: [{ steps: 1500000, label: "GPU", reward: "üíª" }], user2: [{ steps: 1500000, label: "Heels", reward: "üë†" }] };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCjvDHVf3-WEwxRXt2oTKyS3U-DrUeMJ4Q", authDomain: "a-to-a-walking.firebaseapp.com", projectId: "a-to-a-walking",
            storageBucket: "a-to-a-walking.firebasestorage.app", messagingSenderId: "482552425657", appId: "1:482552425657:web:fbbcc6ef15ca4589ad3f68"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'walking-challenge-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Firestore References
        const publicDataCollection = collection(db, 'artifacts', appId, 'public', 'data', 'challengeData');
        const user1DocRef = doc(publicDataCollection, 'user1');
        const user2DocRef = doc(publicDataCollection, 'user2');
        const logsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'challengeLogs');

        let currentUser = null;
        let userData = { user1: { name: "Ant", steps: 0 }, user2: { name: "Amy", steps: 0 } };
        let logData = [];
        let map = null;
        let markers = null;

        const userSelector = document.getElementById('user-selector');
        const stepForm = document.getElementById('step-form');
        const stepInput = document.getElementById('step-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const statsFilter = document.getElementById('stats-filter');
        const passportContainer = document.getElementById('passport-container');
        const user1LogContainer = document.getElementById('user1-log');
        const user2LogContainer = document.getElementById('user2-log');
        const user1HighScoreContainer = document.getElementById('user1-highscore');
        const user2HighScoreContainer = document.getElementById('user2-highscore');
        const user1AvgSteps = document.getElementById('user1-avg-steps');
        const user2AvgSteps = document.getElementById('user2-avg-steps');
        const user1PredictedSteps = document.getElementById('user1-predicted-steps');
        const user2PredictedSteps = document.getElementById('user2-predicted-steps');

        // --- Logic ---

        async function initializeUserDocs() {
            try {
                const [u1, u2] = await Promise.all([getDoc(user1DocRef), getDoc(user2DocRef)]);
                if (!u1.exists()) await setDoc(user1DocRef, { name: "Ant", steps: 0 });
                if (!u2.exists()) await setDoc(user2DocRef, { name: "Amy", steps: 0 });
            } catch (e) { console.error(e); }
        }
        
        function getAllGoalsForUser(userKey) {
            const userMilestones = MASTER_MILESTONES;
            const userStretchGoals = INDIVIDUAL_STRETCH_GOALS[userKey] || [];
            return [...userMilestones, ...SHARED_STRETCH, ...userStretchGoals].sort((a, b) => a.steps - b.steps);
        }

        // --- Render Helpers ---

        function getNextGoal(steps) {
            const allGoals = [...MASTER_MILESTONES, ...SHARED_STRETCH].sort((a,b) => a.steps - b.steps);
            return allGoals.find(g => steps < g.steps) || allGoals[allGoals.length-1];
        }

        function renderBars() {
            const antGoal = getNextGoal(userData.user1.steps);
            const amyGoal = getNextGoal(userData.user2.steps);

            // Ant Bar with Peer Marker
            const antProgress = Math.min(100, (userData.user1.steps / antGoal.steps) * 100);
            const antPeerPos = Math.min(100, (userData.user2.steps / antGoal.steps) * 100);
            
            document.getElementById('ant-progress-row').innerHTML = `
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-green-700">${USER_1_NAME}</span>
                    <span class="text-xs text-gray-500 font-medium">${antGoal.description || antGoal.label}</span>
                </div>
                <div class="progress-bar-track overflow-visible">
                    <div class="progress-bar-fill-ant" style="width: ${antProgress}%"></div>
                    <!-- Peer marker (triangle) pointing up from bottom. Ant's bar shows Amy (Purple) -->
                    <div class="peer-marker bottom" style="left: ${antPeerPos}%; border-bottom-color: #9333ea;" title="${userData.user2.name}"></div>
                </div>
                <div class="text-[10px] flex justify-between mt-1 text-gray-500">
                    <span>${userData.user1.steps.toLocaleString()} steps</span>
                    <span>${(antGoal.steps - userData.user1.steps).toLocaleString()} to go</span>
                </div>
            `;

            // Amy Bar with Peer Marker
            const amyProgress = Math.min(100, (userData.user2.steps / amyGoal.steps) * 100);
            const amyPeerPos = Math.min(100, (userData.user1.steps / amyGoal.steps) * 100);

            document.getElementById('amy-progress-row').innerHTML = `
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-purple-700">${USER_2_NAME}</span>
                    <span class="text-xs text-gray-500 font-medium">${amyGoal.description || amyGoal.label}</span>
                </div>
                <div class="progress-bar-track overflow-visible">
                    <div class="progress-bar-fill-amy" style="width: ${amyProgress}%"></div>
                    <!-- Peer marker (triangle) pointing up from bottom. Amy's bar shows Ant (Green) -->
                    <div class="peer-marker bottom" style="left: ${amyPeerPos}%; border-bottom-color: #22c55e;" title="${userData.user1.name}"></div>
                </div>
                <div class="text-[10px] flex justify-between mt-1 text-gray-500">
                    <span>${userData.user2.steps.toLocaleString()} steps</span>
                    <span>${(amyGoal.steps - userData.user2.steps).toLocaleString()} to go</span>
                </div>
            `;
        }

        function renderPassport() {
            passportContainer.innerHTML = '';
            const unlocked = MASTER_MILESTONES.filter(m => userData.user1.steps >= m.steps || userData.user2.steps >= m.steps).sort((a,b)=>b.steps-a.steps);
            
            if(unlocked.length === 0) { passportContainer.innerHTML = '<p class="col-span-full text-center text-gray-400 italic">No stamps yet!</p>'; return; }

            unlocked.forEach(m => {
                const ant = userData.user1.steps >= m.steps;
                const amy = userData.user2.steps >= m.steps;
                const div = document.createElement('div');
                div.className = 'stamp';
                div.innerHTML = `
                    <p class="text-[10px] font-bold leading-tight px-1 mb-1 text-gray-800">${m.label}</p>
                    <div class="flex gap-2">
                        <span class="text-xs font-black ${ant?'text-green-600':'text-gray-300'}">A</span>
                        <span class="text-xs font-black ${amy?'text-purple-600':'text-gray-300'}">A</span>
                    </div>
                `;
                passportContainer.appendChild(div);
            });
        }

        function renderLogs() {
            const logs = [...logData].sort((a,b) => b.date.toMillis() - a.date.toMillis());
            ['user1', 'user2'].forEach(uid => {
                const el = document.getElementById(`${uid}-log`);
                el.innerHTML = '';
                const uLogs = logs.filter(l => l.userId === uid);
                uLogs.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'log-entry p-2 border rounded text-xs bg-white flex justify-between';
                    const date = l.date.toDate().toLocaleDateString('en-GB', {day:'numeric', month:'short'});
                    div.innerHTML = `
                        <div>
                            <span class="font-bold ${uid==='user1'?'text-green-600':'text-purple-600'}">${l.steps.toLocaleString()}</span>
                            <span class="text-gray-400 ml-1 cursor-pointer hover:underline edit-date" data-id="${l.id}" data-date="${l.date.toDate().toISOString().split('T')[0]}">${date}</span>
                            ${l.note ? `<div class="text-gray-600 italic truncate w-24 sm:w-32">"${l.note}"</div>` : ''}
                            ${l.locationName ? `<div class="text-gray-500 truncate w-24 sm:w-32">üìç ${l.locationName}</div>` : ''}
                        </div>
                        <div class="flex gap-1 items-center">
                            <button class="text-gray-400 hover:text-gray-600 edit-loc" data-id="${l.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                            <button class="text-blue-400 hover:text-blue-600 edit-note" data-id="${l.id}" data-note="${l.note||''}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </button>
                            <button class="text-red-400 hover:text-red-600 del-log" data-id="${l.id}" data-steps="${l.steps}" data-uid="${uid}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    `;
                    el.appendChild(div);
                });
            });
        }

        function calculateAndRenderStats() {
            const filterValue = statsFilter.value;
            const today = new Date();
            const challengeStart = new Date(2025, 9, 1); 

            ['user1', 'user2'].forEach(userKey => {
                const userLogs = logData.filter(log => log.userId === userKey);
                let totalSteps = 0;
                let divisor = 1;
                let multiplier = 365; 
                let averageSteps = 0;

                if (!userData[userKey]) return;

                if (filterValue === 'all') {
                    totalSteps = userData[userKey].steps;
                    const diffTime = Math.max(0, today - challengeStart);
                    divisor = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    multiplier = 365;
                } else {
                    const [yearStr, monthStr] = filterValue.split('-');
                    const year = parseInt(yearStr);
                    const month = parseInt(monthStr);

                    const filteredLogs = userLogs.filter(log => {
                        const d = log.date.toDate();
                        return d.getFullYear() === year && d.getMonth() === month;
                    });
                    totalSteps = filteredLogs.reduce((sum, log) => sum + log.steps, 0);

                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    multiplier = daysInMonth;

                    if (year === today.getFullYear() && month === today.getMonth()) {
                        divisor = today.getDate();
                    } else {
                        divisor = daysInMonth;
                    }
                }
                
                divisor = Math.max(1, divisor);
                averageSteps = totalSteps / divisor;
                const predictedSteps = averageSteps * multiplier;

                const avgTarget = document.getElementById(`${userKey}-avg-steps`);
                const predTarget = document.getElementById(`${userKey}-predicted-steps`);
                
                if (avgTarget) avgTarget.textContent = Math.round(averageSteps).toLocaleString();
                if (predTarget) predTarget.textContent = Math.round(predictedSteps).toLocaleString();
            });
        }
        
        function renderMap() {
            if (!map || !markers) return;
            markers.clearLayers();

            logData.forEach(log => {
                if(log.lat && log.lng) {
                    const isAnt = log.userId === 'user1';
                    // Updated to use standard Leaflet marker colors (simulated with CSS filter in style block)
                    const iconClass = isAnt ? 'marker-icon-ant' : 'marker-icon-amy';
                    
                    const icon = L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                        className: iconClass // Apply CSS filter for color
                    });

                    const marker = L.marker([log.lat, log.lng], { icon: icon });
                    
                    // Simplify location text to first comma
                    const shortLocation = log.locationName ? log.locationName.split(',')[0] : '';
                    
                    // Improved compact popup structure
                    const popupContent = `
                        <div class="text-sm font-sans">
                            <div class="font-bold flex items-center gap-1 mb-1 border-b pb-1">
                                <span class="${isAnt ? 'text-green-600' : 'text-purple-600'} text-base">${isAnt ? USER_1_NAME : USER_2_NAME}</span>
                                <span class="text-gray-400 mx-1">‚Ä¢</span>
                                <span>${log.steps.toLocaleString()}</span>
                                <span class="text-gray-400 mx-1">‚Ä¢</span>
                                <span class="text-gray-500 font-normal">${log.date.toDate().toLocaleDateString('en-GB', {day:'numeric', month:'short'})}</span>
                            </div>
                            
                            ${log.note ? `<div class="italic text-gray-700 mb-1">"${log.note}"</div>` : ''}
                            ${shortLocation ? `<div class="text-gray-500 text-xs flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> ${shortLocation}</div>` : ''}
                        </div>`;
                    
                    marker.bindPopup(popupContent, { maxWidth: 220 });
                    markers.addLayer(marker);
                }
            });
        }

        function renderStretch() {
            const div = document.getElementById('stretch-goals-container');
            div.innerHTML = '';
            const end = new Date('2026-10-01');
            const daysLeft = Math.max(1, Math.ceil((end - new Date())/86400000));
            
            SHARED_STRETCH.forEach(g => {
                const done = userData.user1.steps >= g.steps && userData.user2.steps >= g.steps;
                const rem1 = Math.max(0, g.steps - userData.user1.steps), rem2 = Math.max(0, g.steps - userData.user2.steps);
                div.innerHTML += `<div class="bg-white p-3 rounded border-l-4 ${done?'border-amber-400 bg-amber-50':'border-gray-200'} shadow-sm flex justify-between">
                    <div><div class="font-bold text-sm">${g.label}</div><div class="text-xs text-gray-500">${g.steps.toLocaleString()} each</div>
                    ${!done ? `<div class="text-[10px] mt-1">Daily: <span class="text-green-600">${Math.ceil(rem1/daysLeft)}</span> | <span class="text-purple-600">${Math.ceil(rem2/daysLeft)}</span></div>` : ''}
                    </div><div class="text-xl">${g.reward}</div></div>`;
            });
            ['user1','user2'].forEach(uid => {
                (INDIVIDUAL_STRETCH[uid]||[]).forEach(g => {
                    const done = userData[uid].steps >= g.steps;
                    const rem = Math.max(0, g.steps - userData[uid].steps);
                    div.innerHTML += `<div class="bg-white p-3 rounded border-l-4 ${done?'border-amber-400 bg-amber-50':'border-gray-200'} shadow-sm flex justify-between">
                        <div><div class="font-bold text-sm">${g.label} (${userData[uid].name})</div><div class="text-xs text-gray-500">${g.steps.toLocaleString()}</div>
                        ${!done ? `<div class="text-[10px] mt-1 text-${uid==='user1'?'green':'purple'}-600">Daily: ${Math.ceil(rem/daysLeft)}</div>` : ''}
                        </div><div class="text-xl">${g.reward}</div></div>`;
                });
            });
        }

        function renderHighScores() {
            ['user1','user2'].forEach(uid => {
                const uLogs = logData.filter(l => l.userId === uid);
                const best = uLogs.reduce((m, l) => l.steps > m.steps ? l : m, {steps:0});
                
                const dateStr = best.date ? best.date.toDate().toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'}) : '-';
                const color = uid==='user1'?'green':'purple';
                
                // Show both location and note if available
                let details = '';
                if (best.locationName) details += `<div class="text-xs text-gray-400 mt-1 flex justify-center items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${best.locationName}</div>`;
                if (best.note) details += `<div class="text-sm text-gray-800 font-medium italic px-2 mt-1">"${best.note}"</div>`;
                
                if (!details) details = `<div class="text-sm text-gray-800 font-medium italic px-2 mt-1">"Amazing effort! üöÄ"</div>`;
                
                document.getElementById(`${uid}-highscore`).innerHTML = best.steps > 0 ? 
                    `<div class="bg-amber-50 border-2 border-amber-300 p-3 rounded-lg text-center shadow-sm relative overflow-hidden">
                        <div class="text-2xl font-black text-${color}-600 mb-1">${best.steps.toLocaleString()}</div>
                        <div class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-1">${dateStr}</div>
                        ${details}
                    </div>` : 
                    '<div class="text-center text-xs text-gray-400 italic py-4">No Data Yet</div>';
            });
        }

        // --- Interaction ---
        const modal = document.getElementById('modal-overlay');
        const showModal = (title, content, onConfirm) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            const confirmBtn = document.getElementById('modal-confirm');
            const newConfirm = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
            newConfirm.addEventListener('click', () => { onConfirm(); modal.classList.add('hidden'); });
            document.getElementById('modal-cancel').onclick = () => modal.classList.add('hidden');
        };

        document.addEventListener('click', async e => {
            const btn = e.target.closest('button');
            const span = e.target.closest('span.edit-date');
            if(span) {
                showModal('Change Date', `<input type="date" id="m-date" value="${span.dataset.date}" class="w-full border p-2 rounded">`, async () => {
                    const d = document.getElementById('m-date').value;
                    if(d) await updateDoc(doc(logsCollectionRef, span.dataset.id), { date: Timestamp.fromDate(new Date(d)) });
                });
            }
            if(!btn) return;
            
            if(btn.classList.contains('edit-note')) {
                showModal('Edit Note', `<textarea id="m-note" class="w-full border p-2 rounded" maxlength="150">${btn.dataset.note}</textarea>`, async () => {
                    await updateDoc(doc(logsCollectionRef, btn.dataset.id), { note: document.getElementById('m-note').value });
                });
            }
            if(btn.classList.contains('edit-loc')) {
                showModal('Add Location', `<input id="m-loc" class="w-full border p-2 rounded" placeholder="e.g. Eiffel Tower">`, async () => {
                    const q = document.getElementById('m-loc').value;
                    if(!q) return;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`);
                    const data = await res.json();
                    if(data.length) await updateDoc(doc(logsCollectionRef, btn.dataset.id), { locationName: data[0].display_name.split(',')[0], lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) });
                });
            }
            if(btn.classList.contains('del-log')) {
                showModal('Delete Entry?', '<p class="text-red-600">This cannot be undone.</p>', async () => {
                    const { id, steps, uid } = btn.dataset;
                    await runTransaction(db, async t => {
                        const ref = uid==='user1'?user1DocRef:user2DocRef;
                        const u = await t.get(ref);
                        t.update(ref, { steps: Math.max(0, u.data().steps - parseInt(steps)) });
                        t.delete(doc(logsCollectionRef, id));
                    });
                });
            }
        });

        function setupStatsFilter() {
            const start = new Date(2025, 9, 1);
            const now = new Date();
            const filter = document.getElementById('stats-filter');
            let html = '<option value="all">All Time</option>';
            let current = new Date(start);
            let currentYear = -1;
            while (current <= now || (current.getMonth() === now.getMonth() && current.getFullYear() === now.getFullYear())) {
                const y = current.getFullYear();
                const m = current.getMonth();
                const mName = current.toLocaleString('default', { month: 'short' });
                if (y !== currentYear) {
                    if (currentYear !== -1) html += '</optgroup>';
                    html += `<optgroup label="${y}">`;
                    currentYear = y;
                }
                html += `<option value="${y}-${m}">${mName} ${y}</option>`;
                current.setMonth(current.getMonth() + 1);
            }
            if (currentYear !== -1) html += '</optgroup>';
            filter.innerHTML = html;
            filter.addEventListener('change', updateUI);
        }

        function setupUserSelector() {
            ['user1', 'user2'].forEach(userKey => {
                const button = document.createElement('button');
                button.dataset.user = userKey;
                button.textContent = userData[userKey].name;
                button.className = "px-6 py-2 text-lg font-semibold border-2 border-transparent rounded-lg transition bg-gray-200";
                userSelector.appendChild(button);
            });

            userSelector.addEventListener("click", e => {
                if (e.target.tagName !== 'BUTTON') return;

                currentUser = e.target.dataset.user;
                const isAnt = currentUser === 'user1';
                
                Array.from(userSelector.children).forEach(button => {
                    const isSelected = button.dataset.user === currentUser;
                    button.classList.remove('bg-green-500', 'bg-purple-500', 'text-white', 'bg-gray-200');
                    if (isSelected) {
                        button.classList.add(isAnt ? 'bg-green-500' : 'bg-purple-500', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200');
                    }
                });
                
                const formButton = stepForm.querySelector('button[type="submit"]');
                formButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-purple-500', 'hover:bg-purple-600');
                stepInput.classList.remove('focus:ring-2', 'focus:ring-green-500', 'focus:ring-purple-500');
                
                if (isAnt) {
                    formButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-green-500');
                } else {
                    formButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-purple-500');
                }

                stepForm.classList.remove("hidden");
                stepInput.focus();
            });
        }

        async function handleStepSubmit(e) {
            e.preventDefault();
            if (!currentUser) return;
            const steps = parseInt(stepInput.value, 10);
            if (isNaN(steps) || steps <= 0) return;
            
            stepInput.disabled = true;
            try {
                await runTransaction(db, async (t) => {
                    const uDoc = await t.get(currentUser === 'user1' ? user1DocRef : user2DocRef);
                    const newTotal = uDoc.data().steps + steps;
                    t.update(uDoc.ref, { steps: newTotal });
                    t.set(doc(logsCollectionRef), {
                        userId: currentUser, steps: steps, note: "", date: Timestamp.now()
                    });
                });
                stepForm.reset();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            } catch (err) { console.error(err); }
            finally { stepInput.disabled = false; }
        }

        // Move updateUI definition before main calls it
        function updateUI() {
            if (!userData.user1 || !userData.user2) return;
            renderBars();
            renderPassport();
            renderLogs();
            calculateAndRenderStats();
            renderStretch();
            renderHighScores();
            renderMap();
            setTimeout(() => document.querySelectorAll('.milestone').forEach(m => m.classList.add('visible')), 100);
        }

        // --- Setup ---
        function initializeMap() {
            map = L.map('map').setView([54.5, -2.5], 6); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markers = L.layerGroup().addTo(map);
        }

        async function main() {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Authentication failed", e); }
            
            await initializeUserDocs();
            initializeMap();
            setupUserSelector();
            setupStatsFilter();
            stepForm.addEventListener('submit', handleStepSubmit);

            // --- Real-time Listeners ---
            onSnapshot(user1DocRef, (doc) => {
                if(doc.exists()) userData.user1 = { ...userData.user1, ...doc.data() };
                updateUI();
            });
            onSnapshot(user2DocRef, (doc) => {
                if(doc.exists()) userData.user2 = { ...userData.user2, ...doc.data() };
                updateUI();
            });
            const logsQuery = query(logsCollectionRef, orderBy("date", "desc"));
            onSnapshot(logsQuery, (snapshot) => {
                logData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
        }

        main();

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
