<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A to A Walking Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .progress-bar-track {
            background-color: #e0e0e0;
            border: 2px solid #d1d5db;
            height: 48px;
            border-radius: 9999px;
            position: relative;
        }
        .progress-bar-fill-ant {
            background: linear-gradient(to right, #4ade80, #34d399);
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            height: 100%;
            border-radius: 9999px;
        }
        .progress-bar-fill-amy {
            background: linear-gradient(to right, #a855f7, #9333ea);
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            height: 100%;
            border-radius: 9999px;
        }
        .peer-marker {
            position: absolute;
            top: -8px;
            transform: translateX(-50%);
            transition: left 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            z-index: 10;
        }
        .passport-bg {
            background-color: #fdf6e3;
            background-image: radial-gradient(#d3c9b1 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            border: 2px solid #d3c9b1;
        }
        .stamp {
            border: 3px double #8b7355;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        .log-entry {
            transition: background-color 0.2s ease-in-out;
        }
        #map {
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-8">

        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">A to A Walking!</h1>
            <p class="text-gray-500 mt-2 italic">Est. Oct 25</p>
        </div>

        <!-- Log Steps Section -->
        <div class="bg-gray-50 p-4 sm:p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-lg font-semibold text-center mb-4">Log Daily Steps</h2>
            <div class="flex justify-center gap-4 mb-4" id="user-selector"></div>
            <form id="step-form" class="hidden flex flex-col sm:flex-row items-center justify-center gap-3">
                <input type="number" id="step-input" placeholder="0 steps" class="w-full sm:w-48 text-center p-3 border border-gray-300 rounded-lg focus:border-transparent transition" required min="1">
                <button type="submit" class="w-full sm:w-auto text-white font-bold py-3 px-6 rounded-lg transition-all shadow-md active:scale-95">
                    Add Steps
                </button>
            </form>
            <p id="feedback-message" class="text-center text-green-600 font-medium mt-3 h-5"></p>
        </div>

        <!-- Progress Bars Section -->
        <div class="space-y-8 mb-10 px-2">
            <!-- Ant's Row -->
            <div id="ant-progress-row" class="w-full">
                <!-- Content generated by JS -->
            </div>
            <!-- Amy's Row -->
            <div id="amy-progress-row" class="w-full">
                <!-- Content generated by JS -->
            </div>
        </div>

        <!-- Stats Section -->
        <div class="mt-8 pt-8 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-700">Stats</h2>
                <select id="stats-filter" class="p-2 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                <!-- Ant Stats -->
                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <p class="text-[10px] uppercase tracking-wider text-green-700 font-bold mb-2">Ant</p>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <p class="text-xs text-gray-500">Average</p>
                            <p id="user1-avg-steps" class="text-lg font-bold text-green-600">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Predicted</p>
                            <p id="user1-predicted-steps" class="text-lg font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>
                <!-- Amy Stats -->
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <p class="text-[10px] uppercase tracking-wider text-purple-700 font-bold mb-2">Amy</p>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <p class="text-xs text-gray-500">Average</p>
                            <p id="user2-avg-steps" class="text-lg font-bold text-purple-600">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Predicted</p>
                            <p id="user2-predicted-steps" class="text-lg font-bold text-purple-600">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Passport Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6 flex items-center justify-center gap-2">
                <span>üõÇ</span> Passport
            </h2>
            <div id="passport-container" class="passport-bg rounded-2xl p-4 sm:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[100px]">
                <!-- Stamps injected here -->
            </div>
        </div>

        <!-- Stretch Goals Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Stretch Goals</h2>
            <div id="stretch-goals-container" class="space-y-4"></div>
        </div>

        <!-- High Score Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">High Scores</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Ant's Best Day</h3>
                    <div id="user1-highscore">
                        <!-- High score for user 1 will be injected here -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Amy's Best Day</h3>
                    <div id="user2-highscore">
                        <!-- High score for user 2 will be injected here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Log Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Daily Log</h2>
            <div class="grid grid-cols-2 gap-2 sm:gap-4">
                <div>
                    <h3 class="text-sm font-bold text-center mb-4 text-green-700 bg-green-100 py-1 rounded">Ant</h3>
                    <div id="user1-log" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-center mb-4 text-purple-700 bg-purple-100 py-1 rounded">Amy</h3>
                    <div id="user2-log" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Our Journey</h2>
            <div id="map" class="h-64 sm:h-96 w-full rounded-lg shadow-md"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Add a Note</h3>
            <form id="note-form">
                <textarea id="note-input" maxlength="150" class="w-full p-2 border border-gray-300 rounded-lg h-24 resize-none" placeholder="Details..."></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="note-cancel" class="bg-gray-200 p-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 text-white p-2 rounded-lg font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="date-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Change Date</h3>
            <form id="date-form">
                <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="date-cancel" class="bg-gray-200 p-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 text-white p-2 rounded-lg font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="location-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Add Location</h3>
            <p class="text-sm text-gray-500 mb-4">Enter a place name, like "Snowdon Summit" or a postcode.</p>
            <form id="location-form">
                <input id="location-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Eiffel Tower">
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="location-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Search & Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, orderBy, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ‚öôÔ∏è CHALLENGE DATA ---
        const USER_1_NAME = "Ant";
        const USER_2_NAME = "Amy";
        
        // Combined Milestone List for Passport Logic
        // We'll use this to check which stamps to show
        const MASTER_MILESTONES = [
            { steps: 8073, label: "To the In-laws! üè°" },
            { steps: 37063, label: "Long parental trek! üö∂‚Äç‚ôÇÔ∏è" },
            { steps: 54854, label: "The Marathon! üèÉ‚Äç‚ôÄÔ∏è" },
            { steps: 130000, label: "Birmingham! üèôÔ∏è" },
            { steps: 156000, label: "The 24h Walk! üåô" },
            { steps: 227708, label: "Cardiff Reached! üêâ" },
            { steps: 283335, label: "Dublin crossing! üçÄ" },
            { steps: 342212, label: "London Town! üíÇ" },
            { steps: 418483, label: "Edinburgh Castle! üè∞" },
            { steps: 480597, label: "Channel Tunnel! üöá" },
            { steps: 520000, label: "Reached the ISS! üõ∞Ô∏è" },
            { steps: 537316, label: "Bienvenue √† Calais! üá´üá∑" },
            { steps: 616174, label: "Bruges Market! üè∞" },
            { steps: 700167, label: "Amsterdam Canals! üö≤" },
            { steps: 731601, label: "Brussels Base! üáßüá™" },
            { steps: 751023, label: "Paris Border! üóº" },
            { steps: 784043, label: "Eiffel Tower! üéâ" },
            { steps: 836859, label: "The Long Walk! üéûÔ∏è" },
            { steps: 954265, label: "Dortmund Goal! ‚öΩ" }
        ];

        const SHARED_STRETCH_GOALS = [{ steps: 1000000, label: "Book Disneyland Paris!", reward: "üè∞üê≠" }];
        const INDIVIDUAL_STRETCH_GOALS = {
            user1: [{ steps: 1500000, label: "New Graphics Card!", reward: "üíª" }],
            user2: [{ steps: 1500000, label: "New Pair of Heels!", reward: "üë†" }]
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyCjvDHVf3-WEwxRXt2oTKyS3U-DrUeMJ4Q",
                authDomain: "a-to-a-walking.firebaseapp.com",
                projectId: "a-to-a-walking",
                storageBucket: "a-to-a-walking.firebasestorage.app",
                messagingSenderId: "482552425657",
                appId: "1:482552425657:web:fbbcc6ef15ca4589ad3f68"
              };
		
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'walking-challenge-app';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Firestore References (MOVED HERE to avoid ReferenceError) ---
        const publicDataCollection = collection(db, 'artifacts', appId, 'public', 'data', 'challengeData');
        const user1DocRef = doc(publicDataCollection, 'user1');
        const user2DocRef = doc(publicDataCollection, 'user2');
        const logsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'challengeLogs');

        let currentUser = null;
        let userData = { user1: { name: USER_1_NAME, steps: 0 }, user2: { name: USER_2_NAME, steps: 0 }};
        let logData = [];
        let map = null;
        let markers = null;

        const userSelector = document.getElementById('user-selector');
        const stepForm = document.getElementById('step-form');
        const stepInput = document.getElementById('step-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const statsFilter = document.getElementById('stats-filter');
        const passportContainer = document.getElementById('passport-container');
        const user1LogContainer = document.getElementById('user1-log');
        const user2LogContainer = document.getElementById('user2-log');
        const user1HighScoreContainer = document.getElementById('user1-highscore');
        const user2HighScoreContainer = document.getElementById('user2-highscore');
        
        const noteModal = document.getElementById('note-modal');
        const noteForm = document.getElementById('note-form');
        const noteInput = document.getElementById('note-input');
        const noteCancelBtn = document.getElementById('note-cancel');
        
        const locationModal = document.getElementById('location-modal');
        const locationForm = document.getElementById('location-form');
        const locationInput = document.getElementById('location-input');
        const locationCancelBtn = document.getElementById('location-cancel');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        const dateModal = document.getElementById('date-modal');
        const dateForm = document.getElementById('date-form');
        const dateInput = document.getElementById('date-input');
        const dateCancelBtn = document.getElementById('date-cancel');
        
        const user1AvgSteps = document.getElementById('user1-avg-steps');
        const user2AvgSteps = document.getElementById('user2-avg-steps');
        const user1PredictedSteps = document.getElementById('user1-predicted-steps');
        const user2PredictedSteps = document.getElementById('user2-predicted-steps');
        
        // --- Logic ---

        async function initializeUserDocs() {
            try {
                const [user1Doc, user2Doc] = await Promise.all([getDoc(user1DocRef), getDoc(user2DocRef)]);
                if (!user1Doc.exists()) await setDoc(user1DocRef, { name: USER_1_NAME, steps: 0 });
                if (!user2Doc.exists()) await setDoc(user2DocRef, { name: USER_2_NAME, steps: 0 });
            } catch (error) { console.error("Error initializing user documents:", error); }
        }
        
        function getAllGoalsForUser(userKey) {
            // FIXED: Use MASTER_MILESTONES instead of undefined MILESTONES
            const userMilestones = MASTER_MILESTONES;
            const userStretchGoals = INDIVIDUAL_STRETCH_GOALS[userKey] || [];
            return [...userMilestones, ...SHARED_STRETCH_GOALS, ...userStretchGoals].sort((a, b) => a.steps - b.steps);
        }

        // --- Render Helpers ---

        function getNextGoal(steps) {
            const allGoals = [...MASTER_MILESTONES, ...SHARED_STRETCH_GOALS].sort((a,b) => a.steps - b.steps);
            return allGoals.find(g => steps < g.steps) || allGoals[allGoals.length-1];
        }

        function renderBars() {
            const antGoal = getNextGoal(userData.user1.steps);
            const amyGoal = getNextGoal(userData.user2.steps);

            // Ant Bar
            const antProgress = Math.min(100, (userData.user1.steps / antGoal.steps) * 100);
            const antPeerPos = Math.min(100, (userData.user2.steps / antGoal.steps) * 100);
            
            document.getElementById('ant-progress-row').innerHTML = `
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-green-700">${USER_1_NAME}</span>
                    <span class="text-xs text-gray-500 font-medium">${antGoal.label}</span>
                </div>
                <div class="progress-bar-track overflow-visible">
                    <div class="progress-bar-fill-ant" style="width: ${antProgress}%"></div>
                    <div class="peer-marker" style="left: ${antPeerPos}%">
                        <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[10px] border-t-purple-600"></div>
                    </div>
                </div>
                <div class="text-[10px] flex justify-between mt-1 text-gray-500">
                    <span>${userData.user1.steps.toLocaleString()} steps</span>
                    <span>${(antGoal.steps - userData.user1.steps).toLocaleString()} to go</span>
                </div>
            `;

            // Amy Bar
            const amyProgress = Math.min(100, (userData.user2.steps / amyGoal.steps) * 100);
            const amyPeerPos = Math.min(100, (userData.user1.steps / amyGoal.steps) * 100);

            document.getElementById('amy-progress-row').innerHTML = `
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-purple-700">${USER_2_NAME}</span>
                    <span class="text-xs text-gray-500 font-medium">${amyGoal.label}</span>
                </div>
                <div class="progress-bar-track overflow-visible">
                    <div class="progress-bar-fill-amy" style="width: ${amyProgress}%"></div>
                    <div class="peer-marker" style="left: ${amyPeerPos}%">
                        <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[10px] border-t-green-600"></div>
                    </div>
                </div>
                <div class="text-[10px] flex justify-between mt-1 text-gray-500">
                    <span>${userData.user2.steps.toLocaleString()} steps</span>
                    <span>${(amyGoal.steps - userData.user2.steps).toLocaleString()} to go</span>
                </div>
            `;
        }

        function renderPassport() {
            passportContainer.innerHTML = '';
            // Only show milestones where at least one person has reached it
            const unlocked = MASTER_MILESTONES.filter(m => 
                userData.user1.steps >= m.steps || userData.user2.steps >= m.steps
            ).sort((a,b) => b.steps - a.steps); // Newest first

            if(unlocked.length === 0) {
                passportContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full italic py-10">Waiting for your first stamp! üë£</p>';
                return;
            }

            unlocked.forEach(m => {
                const antDone = userData.user1.steps >= m.steps;
                const amyDone = userData.user2.steps >= m.steps;
                
                const stamp = document.createElement('div');
                stamp.className = 'stamp rounded-xl p-3 flex flex-col items-center justify-center text-center shadow-sm';
                stamp.innerHTML = `
                    <p class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter mb-1">Milestone</p>
                    <p class="text-sm font-bold text-gray-800 leading-tight mb-2">${m.label}</p>
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-black ${antDone ? 'text-green-500' : 'text-gray-300'}">A</span>
                            <span class="text-[8px] text-gray-400">Ant</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-black ${amyDone ? 'text-purple-500' : 'text-gray-300'}">A</span>
                            <span class="text-[8px] text-gray-400">Amy</span>
                        </div>
                    </div>
                `;
                passportContainer.appendChild(stamp);
            });
        }

        function renderLogs() {
            user1LogContainer.innerHTML = '';
            user2LogContainer.innerHTML = '';
            
            const sortedLogs = [...logData].sort((a, b) => b.date.toMillis() - a.date.toMillis());

            sortedLogs.forEach(log => {
                const container = log.userId === 'user1' ? user1LogContainer : user2LogContainer;
                const entryEl = document.createElement('div');
                entryEl.className = 'log-entry p-3 border rounded-lg flex justify-between items-start';
                
                const date = log.date.toDate();
                const formattedDate = date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' });
                const isoDate = date.toISOString().split('T')[0];
                const colorClass = log.userId === 'user1' ? 'text-green-600' : 'text-purple-600';
                
                entryEl.innerHTML = `
                    <div class="flex-grow">
                         <div class="flex items-center">
                            <span class="font-bold ${colorClass} mr-2">${log.steps.toLocaleString()}</span>
                            <button type="button" class="edit-date-btn text-sm text-gray-500 cursor-pointer hover:underline" data-log-id="${log.id}" data-date="${isoDate}">
                                ${formattedDate}
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">${log.note || ''}</p>
                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                            ${log.locationName ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${log.locationName}` : ''}
                        </p>
                    </div>
                    <div class="log-actions flex items-center gap-2 ml-2">
                        <button data-log-id="${log.id}" class="edit-location-btn text-gray-500 hover:text-gray-700 p-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${log.id}" data-note="${log.note || ''}" class="edit-note-btn text-blue-500 hover:text-blue-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${log.id}" data-steps="${log.steps}" data-user-id="${log.userId}" class="delete-log-btn text-red-500 hover:text-red-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(entryEl);
            });
        }
        
        function renderHighScores() {
            user1HighScoreContainer.innerHTML = '';
            user2HighScoreContainer.innerHTML = '';

            ['user1', 'user2'].forEach(userKey => {
                const userLogs = logData.filter(log => log.userId === userKey);
                const container = userKey === 'user1' ? user1HighScoreContainer : user2HighScoreContainer;

                if (userLogs.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 italic">No entries yet.</p>`;
                    return;
                }

                const highScoreLog = userLogs.reduce((max, log) => log.steps > max.steps ? log : max, userLogs[0]);

                const entryEl = document.createElement('div');
                entryEl.className = 'log-entry p-3 border-2 border-amber-400 bg-amber-50 rounded-lg flex justify-between items-start shadow';

                const date = highScoreLog.date.toDate();
                const formattedDate = date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' });
                const isoDate = date.toISOString().split('T')[0];
                const colorClass = highScoreLog.userId === 'user1' ? 'text-green-600' : 'text-purple-600';

                entryEl.innerHTML = `
                    <div class="flex-grow">
                         <div class="flex items-center">
                            <span class="font-bold ${colorClass} text-lg mr-2">${highScoreLog.steps.toLocaleString()} üèÜ</span>
                            <button type="button" class="edit-date-btn text-sm text-gray-500 cursor-pointer hover:underline" data-log-id="${highScoreLog.id}" data-date="${isoDate}">
                                ${formattedDate}
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">${highScoreLog.note || ''}</p>
                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                            ${highScoreLog.locationName ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${highScoreLog.locationName}` : ''}
                        </p>
                    </div>
                    <div class="log-actions flex items-center gap-2 ml-2">
                        <button data-log-id="${highScoreLog.id}" class="edit-location-btn text-gray-500 hover:text-gray-700 p-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${highScoreLog.id}" data-note="${highScoreLog.note || ''}" class="edit-note-btn text-blue-500 hover:text-blue-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${highScoreLog.id}" data-steps="${highScoreLog.steps}" data-user-id="${highScoreLog.userId}" class="delete-log-btn text-red-500 hover:text-red-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(entryEl);
            });
        }

        function renderStretchGoals() {
            const container = document.getElementById("stretch-goals-container");
            container.innerHTML = "";

            const endDate = new Date('2026-10-01T00:00:00');
            const today = new Date();
            const daysRemaining = Math.max(1, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));

            const bothUsersExist = userData.user1 && userData.user2;

            // Render Shared Goals
            SHARED_STRETCH_GOALS.forEach(goal => {
                const isAchieved = bothUsersExist && userData.user1.steps >= goal.steps && userData.user2.steps >= goal.steps;
                
                const antStepsNeeded = Math.max(0, goal.steps - (userData.user1?.steps || 0));
                const amyStepsNeeded = Math.max(0, goal.steps - (userData.user2?.steps || 0));
                const antDailyAvg = Math.ceil(antStepsNeeded / daysRemaining);
                const amyDailyAvg = Math.ceil(amyStepsNeeded / daysRemaining);

                const dailyAvgHtml = isAchieved ? '' : `
                    <p class="text-xs text-gray-500 mt-1">
                        Daily avg needed: 
                        <span class="font-bold text-green-600">Ant: ${antDailyAvg.toLocaleString()}</span> | 
                        <span class="font-bold text-purple-600">Amy: ${amyDailyAvg.toLocaleString()}</span>
                    </p>`;

                const goalEl = document.createElement("div");
                goalEl.className = `stretch-goal-card bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-gray-300 ${isAchieved ? "achieved bg-amber-50" : ""}`;
                goalEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg ${isAchieved ? "text-amber-700" : "text-gray-800"}">${goal.label} (Shared)</p>
                        <p class="text-sm text-gray-500">${goal.steps.toLocaleString()} steps each</p>
                        ${dailyAvgHtml}
                    </div>
                    <div class="text-3xl">${goal.reward}</div>`;
                container.appendChild(goalEl);
            });

            // Render Individual Goals
            ['user1', 'user2'].forEach(userKey => {
                const user = userData[userKey];
                (INDIVIDUAL_STRETCH_GOALS[userKey] || []).forEach(goal => {
                    if (!user) return;
                    const isAchieved = user.steps >= goal.steps;
                    
                    const stepsNeeded = Math.max(0, goal.steps - user.steps);
                    const dailyAvg = Math.ceil(stepsNeeded / daysRemaining);
                    
                    const colorClass = userKey === 'user1' ? 'text-green-600' : 'text-purple-600';
                    const dailyAvgHtml = isAchieved ? '' : `
                        <p class="text-xs text-gray-500 mt-1">
                            Daily avg needed: <span class="font-bold ${colorClass}">${dailyAvg.toLocaleString()}</span>
                        </p>`;

                    const goalEl = document.createElement("div");
                    goalEl.className = `stretch-goal-card bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-gray-300 ${isAchieved ? "achieved bg-amber-50" : ""}`;
                    goalEl.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg ${isAchieved ? "text-amber-700" : "text-gray-800"}">${goal.label} (${user.name})</p>
                            <p class="text-sm text-gray-500">${goal.steps.toLocaleString()} steps</p>
                            ${dailyAvgHtml}
                        </div>
                        <div class="text-3xl">${goal.reward}</div>`;
                    container.appendChild(goalEl);
                });
            });
        }

        // UPDATED: Logic for dynamic stats filter and calculation
        function setupStatsFilter() {
            const start = new Date(2025, 9, 1); // Oct 1, 2025
            const now = new Date();
            const filter = document.getElementById('stats-filter');
            
            let html = '<option value="all">All Time</option>';
            
            let current = new Date(start);
            let currentYear = -1;
            
            // Loop from start date until we pass the current date
            while (current <= now || (current.getMonth() === now.getMonth() && current.getFullYear() === now.getFullYear())) {
                const y = current.getFullYear();
                const m = current.getMonth();
                const mName = current.toLocaleString('default', { month: 'short' });
                
                if (y !== currentYear) {
                    if (currentYear !== -1) html += '</optgroup>';
                    html += `<optgroup label="${y}">`;
                    currentYear = y;
                }
                
                html += `<option value="${y}-${m}">${mName} ${y}</option>`;
                
                // Move to next month
                current.setMonth(current.getMonth() + 1);
            }
            if (currentYear !== -1) html += '</optgroup>';
            
            filter.innerHTML = html;
            filter.addEventListener('change', updateUI);
        }

        function calculateAndRenderStats() {
            const filterValue = statsFilter.value;
            const today = new Date();
            const challengeStart = new Date(2025, 9, 1); // Oct 1, 2025

            ['user1', 'user2'].forEach(userKey => {
                const userLogs = logData.filter(log => log.userId === userKey);
                let totalSteps = 0;
                let divisor = 1;
                let multiplier = 365; 
                let averageSteps = 0;

                if (!userData[userKey]) return;

                if (filterValue === 'all') {
                    totalSteps = userData[userKey].steps;
                    const diffTime = Math.max(0, today - challengeStart);
                    divisor = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    multiplier = 365;
                } else {
                    const [yearStr, monthStr] = filterValue.split('-');
                    const year = parseInt(yearStr);
                    const month = parseInt(monthStr);

                    const filteredLogs = userLogs.filter(log => {
                        const d = log.date.toDate();
                        return d.getFullYear() === year && d.getMonth() === month;
                    });
                    totalSteps = filteredLogs.reduce((sum, log) => sum + log.steps, 0);

                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    multiplier = daysInMonth;

                    if (year === today.getFullYear() && month === today.getMonth()) {
                        divisor = today.getDate();
                    } else {
                        divisor = daysInMonth;
                    }
                }
                
                divisor = Math.max(1, divisor);
                averageSteps = totalSteps / divisor;
                const predictedSteps = averageSteps * multiplier;

                const avgTarget = document.getElementById(`${userKey}-avg-steps`);
                const predTarget = document.getElementById(`${userKey}-predicted-steps`);
                
                if (avgTarget) avgTarget.textContent = Math.round(averageSteps).toLocaleString();
                if (predTarget) predTarget.textContent = Math.round(predictedSteps).toLocaleString();
            });
        }
        
        function renderMap() {
            if (!map || !markers) return;
            markers.clearLayers();

            logData.forEach(log => {
                if(log.lat && log.lng) {
                    const isAnt = log.userId === 'user1';
                    const color = isAnt ? '#22c55e' : '#9333ea';
                    
                    const svgIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="${color}">
                            <path d="M12 0C7.589 0 4 3.589 4 8c0 4.411 8 16 8 16s8-11.589 8-16c0-4.411-3.589-8-8-8zm0 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                        </svg>`;

                    const customIcon = L.divIcon({
                        html: svgIcon,
                        className: '',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });

                    const marker = L.marker([log.lat, log.lng], { icon: customIcon });
                    
                    const popupContent = `
                        <div class="text-base">
                            <p class="font-bold">${isAnt ? USER_1_NAME : USER_2_NAME}</p>
                            <p><span class="font-semibold">${log.steps.toLocaleString()}</span> steps</p>
                            <p class="text-sm text-gray-600">${log.date.toDate().toLocaleDateString()}</p>
                            ${log.note ? `<p class="mt-1 italic">"${log.note}"</p>` : ''}
                        </div>`;
                    
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                }
            });
        }

        function updateUI() {
            if (!userData.user1 || !userData.user2) return;
            renderBars();
            renderPassport();
            renderLogs();
            calculateAndRenderStats();
            renderStretchGoals();
            renderHighScores();
            renderMap();
            setTimeout(() => document.querySelectorAll('.milestone').forEach(m => m.classList.add('visible')), 100);
        }

        // --- Event Handlers ---
        
        function setupUserSelector() {
            ['user1', 'user2'].forEach(userKey => {
                const button = document.createElement('button');
                button.dataset.user = userKey;
                button.textContent = userData[userKey].name;
                button.className = "px-6 py-2 text-lg font-semibold border-2 border-transparent rounded-lg transition bg-gray-200";
                userSelector.appendChild(button);
            });

            userSelector.addEventListener("click", e => {
                if (e.target.tagName !== 'BUTTON') return;

                currentUser = e.target.dataset.user;
                const isAnt = currentUser === 'user1';
                
                Array.from(userSelector.children).forEach(button => {
                    const isSelected = button.dataset.user === currentUser;
                    button.classList.remove('bg-green-500', 'bg-purple-500', 'text-white', 'bg-gray-200');
                    if (isSelected) {
                        button.classList.add(isAnt ? 'bg-green-500' : 'bg-purple-500', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200');
                    }
                });
                
                const formButton = stepForm.querySelector('button[type="submit"]');
                formButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-purple-500', 'hover:bg-purple-600');
                stepInput.classList.remove('focus:ring-2', 'focus:ring-green-500', 'focus:ring-purple-500');
                
                if (isAnt) {
                    formButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-green-500');
                } else {
                    formButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-purple-500');
                }

                stepForm.classList.remove("hidden");
                stepInput.focus();
            });
        }
        
        async function handleStepSubmit(e) {
            e.preventDefault();
            if (!currentUser) return;
            const steps = parseInt(stepInput.value, 10);
            if (isNaN(steps) || steps <= 0) return;
            
            stepInput.disabled = true;
            feedbackMessage.textContent = 'Saving...';
            
            const userDocRef = currentUser === 'user1' ? user1DocRef : user2DocRef;
            const oldTotal = userData[currentUser].steps;

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists()) { throw "Document does not exist!"; }
                    const newTotal = userDoc.data().steps + steps;
                    transaction.update(userDocRef, { steps: newTotal });
                    transaction.set(doc(logsCollectionRef), {
                        userId: currentUser,
                        steps: steps,
                        note: "",
                        date: Timestamp.now(),
                        locationName: null,
                        lat: null,
                        lng: null
                    });
                });

                stepForm.reset();
                feedbackMessage.textContent = `Added ${steps.toLocaleString()} steps!`;
                
                const allUserGoals = getAllGoalsForUser(currentUser);
                if (allUserGoals.find(g => oldTotal < g.steps && (oldTotal + steps) >= g.steps)) {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }
            } catch (error) {
                console.error("Error adding steps:", error);
                feedbackMessage.textContent = 'Error saving. Please try again.';
            } finally {
                stepInput.disabled = false;
                setTimeout(() => feedbackMessage.textContent = '', 3000);
            }
        }
        
        // --- Modal Handlers ---
        let confirmCallback = null;
        function showConfirmModal(message, onConfirm) {
            confirmModalText.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        confirmCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        
        let currentLogIdForNote = null;
        function handleOpenNoteModal(e) {
            const button = e.target.closest('.edit-note-btn');
            if (button) {
                currentLogIdForNote = button.dataset.logId;
                noteInput.value = button.dataset.note;
                noteModal.classList.remove('hidden');
                noteInput.focus();
            }
        }
        noteCancelBtn.addEventListener('click', () => noteModal.classList.add('hidden'));
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForNote) return;
            const logDocRef = doc(logsCollectionRef, currentLogIdForNote);
            await updateDoc(logDocRef, { note: noteInput.value });
            noteModal.classList.add('hidden');
            currentLogIdForNote = null;
        });

        let currentLogIdForDate = null;
        function handleOpenDateModal(e) {
            const button = e.target.closest('.edit-date-btn');
            if (button) {
                currentLogIdForDate = button.dataset.logId;
                dateInput.value = button.dataset.date;
                dateModal.classList.remove('hidden');
            }
        }

        dateCancelBtn.addEventListener('click', () => {
            dateModal.classList.add('hidden');
            currentLogIdForDate = null;
        });

        dateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForDate || !dateInput.value) return;
            
            const logDocRef = doc(logsCollectionRef, currentLogIdForDate);
            const newDate = new Date(dateInput.value + "T12:00:00");
            
            try {
                await updateDoc(logDocRef, { date: Timestamp.fromDate(newDate) });
            } catch (error) {
                console.error("Error updating date:", error);
                feedbackMessage.textContent = 'Failed to update date.';
                setTimeout(() => { feedbackMessage.textContent = '' }, 3000);
            } finally {
                dateModal.classList.add('hidden');
                currentLogIdForDate = null;
            }
        });

        let currentLogIdForLocation = null;
        function handleOpenLocationModal(e) {
            const button = e.target.closest('.edit-location-btn');
            if (button) {
                currentLogIdForLocation = button.dataset.logId;
                locationInput.value = '';
                locationModal.classList.remove('hidden');
                locationInput.focus();
            }
        }
        locationCancelBtn.addEventListener('click', () => locationModal.classList.add('hidden'));
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForLocation) return;
            const locationText = locationInput.value.trim();
            if (!locationText) return;

            const button = locationForm.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Searching...';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationText)}&format=json&limit=1`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    const logDocRef = doc(logsCollectionRef, currentLogIdForLocation);
                    await updateDoc(logDocRef, {
                        locationName: display_name,
                        lat: parseFloat(lat),
                        lng: parseFloat(lon)
                    });
                    locationModal.classList.add('hidden');
                } else {
                    alert('Location not found. Please try being more specific.');
                }
            } catch (error) {
                console.error("Error geocoding:", error);
                alert('Could not find location. Please check your connection and try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Search & Save';
            }
        });

        // --- Log Action Handlers (Delegated) ---
        async function handleDeleteLog(e) {
            const button = e.target.closest('.delete-log-btn');
            if (button) {
                const { logId, steps, userId } = button.dataset;
                const stepsToDeduct = parseInt(steps, 10);

                const onConfirm = async () => {
                    const logDocRef = doc(logsCollectionRef, logId);
                    const userDocRef = userId === 'user1' ? user1DocRef : user2DocRef;
                    try {
                        await runTransaction(db, async (transaction) => {
                             const userDoc = await transaction.get(userDocRef);
                             if (!userDoc.exists()) { throw "User document not found"; }
                             const newTotal = Math.max(0, userDoc.data().steps - stepsToDeduct);
                             transaction.update(userDocRef, { steps: newTotal });
                             transaction.delete(logDocRef);
                        });
                    } catch (error) {
                        console.error("Error deleting log entry:", error);
                        feedbackMessage.textContent = 'Failed to delete entry.';
                        setTimeout(() => { feedbackMessage.textContent = '' }, 3000);
                    }
                };
                
                showConfirmModal(`Are you sure you want to delete this log of ${stepsToDeduct.toLocaleString()} steps? This cannot be undone.`, onConfirm);
            }
        }
        
        document.addEventListener('click', (e) => {
            handleOpenNoteModal(e);
            handleDeleteLog(e);
            handleOpenDateModal(e);
            handleOpenLocationModal(e);
        });

        // Initialisation
        function initializeMap() {
            map = L.map('map').setView([54.5, -2.5], 6); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markers = L.layerGroup().addTo(map);
        }

        async function main() {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Authentication failed", e); }
            
            await initializeUserDocs();
            initializeMap();
            setupUserSelector();
            setupStatsFilter();
            stepForm.addEventListener('submit', handleStepSubmit);

            // --- Real-time Listeners ---
            onSnapshot(user1DocRef, (doc) => {
                if(doc.exists()) userData.user1 = { ...userData.user1, ...doc.data() };
                updateUI();
            });
            onSnapshot(user2DocRef, (doc) => {
                if(doc.exists()) userData.user2 = { ...userData.user2, ...doc.data() };
                updateUI();
            });
            const logsQuery = query(logsCollectionRef, orderBy("date", "desc"));
            onSnapshot(logsQuery, (snapshot) => {
                logData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
        }

        main();

    </script>
</body>
</html>
