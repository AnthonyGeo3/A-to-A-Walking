<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A to A Walking Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .progress-bar-container {
            height: 60vh;
            min-height: 400px;
            width: 80px; /* Narrower bars for mobile */
        }
        @media (min-width: 640px) {
            .progress-bar-container {
                width: 100px; /* Wider bars on larger screens */
            }
        }
        .progress-bar-track {
            background-color: #e0e0e0;
            border: 2px solid #d1d5db; /* Lighter border */
        }
        .progress-bar-fill-ant {
            background: linear-gradient(to top, #4ade80, #34d399); /* Green gradient */
            transition: height 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .progress-bar-fill-amy {
            background: linear-gradient(to top, #a855f7, #9333ea); /* Purple gradient */
            transition: height 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .milestone {
            opacity: 0;
            transition: all 0.5s ease-in-out;
        }
        .milestone-line {
            width: 20px;
            height: 2px;
            background-color: #6b7280;
        }
        .milestone-text {
            /* Allow text to wrap */
            white-space: normal;
        }
        .milestone.visible {
            opacity: 1;
        }
        .stretch-goal-card {
            transition: all 0.5s ease;
            border-left-width: 4px;
        }
        .stretch-goal-card.achieved {
            border-left-color: #f59e0b; /* Amber color for achieved */
            transform: scale(1.03);
        }
        .log-entry {
            transition: background-color 0.2s ease-in-out;
        }
        .log-entry:hover {
            background-color: #f9fafb;
        }
        .log-actions button {
            opacity: 0.5;
            transition: opacity 0.2s ease-in-out;
        }
        .log-entry:hover .log-actions button {
            opacity: 1;
        }
        #map {
            z-index: 1; /* Ensures map tiles render correctly */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">A to A Walking!</h1>
            <p class="text-gray-500 mt-2">Walking Challenge: 1st Oct 2025 - 1st Oct 2026</p>
        </div>

        <!-- User Selection and Input Form -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-xl font-semibold text-center mb-4">Log Your Daily Steps</h2>
            <div class="flex justify-center gap-4 mb-4" id="user-selector">
                <!-- User buttons will be inserted here -->
            </div>
            <form id="step-form" class="hidden flex flex-col sm:flex-row items-center justify-center gap-3">
                <input type="number" id="step-input" placeholder="Enter today's steps" class="w-full sm:w-64 text-center p-3 border border-gray-300 rounded-lg focus:border-transparent transition" required min="1">
                <button type="submit" class="w-full sm:w-auto text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow">
                    Add Steps
                </button>
            </form>
            <p id="feedback-message" class="text-center text-green-600 font-medium mt-3 h-5"></p>
        </div>


        <!-- Progress Display -->
        <div class="flex flex-row justify-center items-end gap-2 px-1">
            <!-- User 1 Progress -->
            <div id="user1-progress" class="flex flex-col items-center w-auto"></div>
            <!-- User 2 Progress -->
            <div id="user2-progress" class="flex flex-col items-center w-auto"></div>
        </div>

        <!-- Stats Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Stats</h2>
            <div class="flex justify-center mb-6">
                <select id="stats-filter" class="p-2 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center">
                <!-- Ant's Stats -->
                <div>
                    <h3 class="text-xl font-semibold mb-2">Ant's Stats</h3>
                    <div class="bg-gray-50 p-4 rounded-lg grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Average Daily</p>
                            <p id="user1-avg-steps" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Predicted Total</p>
                            <p id="user1-predicted-steps" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>
                <!-- Amy's Stats -->
                <div>
                    <h3 class="text-xl font-semibold mb-2">Amy's Stats</h3>
                    <div class="bg-gray-50 p-4 rounded-lg grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Average Daily</p>
                            <p id="user2-avg-steps" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Predicted Total</p>
                            <p id="user2-predicted-steps" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Stretch Goals Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Stretch Goals</h2>
            <div id="stretch-goals-container" class="space-y-4">
                <!-- Stretch goals will be inserted here -->
            </div>
        </div>

        <!-- High Score Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">High Scores</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Ant's Best Day</h3>
                    <div id="user1-highscore">
                        <!-- High score for user 1 will be injected here -->
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Amy's Best Day</h3>
                    <div id="user2-highscore">
                        <!-- High score for user 2 will be injected here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Log Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Log</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Ant's Log</h3>
                    <div id="user1-log" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-center mb-4">Amy's Log</h3>
                    <div id="user2-log" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Our Journey</h2>
            <div id="map" class="h-96 w-full rounded-lg shadow-md"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Add a Note</h3>
            <form id="note-form">
                <textarea id="note-input" maxlength="150" class="w-full p-2 border border-gray-300 rounded-lg h-24 resize-none" placeholder="What did you do today? (max 150 chars)"></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="note-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="date-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Change Date</h3>
            <form id="date-form">
                <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="date-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="location-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Add Location</h3>
            <p class="text-sm text-gray-500 mb-4">Enter a place name, like "Snowdon Summit" or a postcode.</p>
            <form id="location-form">
                <input id="location-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Eiffel Tower">
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="location-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Search & Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, orderBy, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ‚öôÔ∏è CUSTOMIZE YOUR CHALLENGE HERE ‚öôÔ∏è ---
        const USER_1_NAME = "Ant";
        const USER_2_NAME = "Amy";
        const MILESTONES = {};
        const SHARED_STRETCH_GOALS = [];
        const INDIVIDUAL_STRETCH_GOALS = {};

        MILESTONES.user1 = [
            { steps: 8073, label: "To Amy's parents! üëã" },
            { steps: 37063, label: "From Amy's to her parents! üö∂‚Äç‚ôÄÔ∏è" },
            { steps: 54854, label: "That's a marathon! üèÉ‚Äç‚ôÇÔ∏è" },
            { steps: 130000, label: "Hello Birmingham! üèôÔ∏è" },
            { steps: 156000, label: "1 full day of walking! ‚òÄÔ∏èüåô" },
            { steps: 227708, label: "Welcome to Cardiff! üêâ" },
            { steps: 256100, label: "To my parents' place! üè†" },
            { steps: 283335, label: "Top of the mornin', Dublin! üçÄ" },
            { steps: 342212, label: "London calling! üíÇ" },
            { steps: 418483, label: "Och aye, Edinburgh! üè∞" },
            { steps: 480597, label: "Channel Tunnel! üöá" },
            { steps: 520000, label: "We've walked to the ISS! üõ∞Ô∏è" },
            { steps: 537316, label: "Bonjour, Calais! üá´üá∑" },
            { steps: 616174, label: "Fairytale Bruges! üè∞" },
            { steps: 700167, label: "Hello Amsterdam! üö≤" },
            { steps: 731601, label: "Brussels Sprouts! üòÑ" },
            { steps: 751023, label: "The outskirts of Paris! ü•ê" },
            { steps: 784043, label: "Eiffel Tower! We made it! üéâ" },
            { steps: 836859, label: "The Long Walk! üö∂‚Äç‚ôÇÔ∏èüëë" },
            { steps: 954265, label: "Goal! Dortmund! ‚öΩ" },
            { steps: 1092000, label: "1 whole week of walking! üóìÔ∏è" },
            { steps: 1145118, label: "Paris to Berlin! ü•ñüç∫" },
            { steps: 1259557, label: "Length of the UK! üá¨üáß" },
            { steps: 1365312, label: "Wonderful Copenhagen! üßú‚Äç‚ôÄÔ∏è" },
            { steps: 1434914, label: "We're in Berlin! üêª" },
            { steps: 1480427, label: "Greetings from Oslo! üá≥üá¥" },
            { steps: 1595568, label: "Fashion capital Milan! üáÆüáπ" },
            { steps: 1716000, label: "¬£100M in tenners, laid end to end! üí∞" },
            { steps: 1761643, label: "Hola, Barcelona! ‚òÄÔ∏è" },
            { steps: 1913990, label: "Florence, city of art! üé®" },
            { steps: 2206035, label: "When in Rome... üèõÔ∏è" },
            { steps: 3437785, label: "Ancient Athens! üá¨üá∑" },
            { steps: 3766100, label: "Shire to Mordor! üåã" },
            { steps: 4469179, label: "Paphos, Cyprus! üá®üáæ" },
        ];
        MILESTONES.user2 = [
            { steps: 8073, label: "Ants' to my parents' house! ‚ù§Ô∏è" },
            { steps: 37063, label: "Visiting my parents! üè°" },
            { steps: 54854, label: "Marathon complete! ‚úÖ" },
            { steps: 130000, label: "Reached Birmingham! ‚ú®" },
            { steps: 156000, label: "24 hours on our feet! üë£" },
            { steps: 227708, label: "Made it to Cardiff! üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø" },
            { steps: 256100, label: "Visiting Ant's parents! üëã" },
            { steps: 283335, label: "Hello Dublin! üáÆüá™" },
            { steps: 342212, label: "We've reached London townnn! üá¨üáß" },
            { steps: 418483, label: "Hello from Edinburgh! üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø" },
            { steps: 480597, label: "Crossing the channel! üåä" },
            { steps: 520000, label: "Up to the ISS! üåç" },
            { steps: 537316, label: "First stop in France! ‚ú®" },
            { steps: 616174, label: "In Bruges! üáßüá™" },
            { steps: 700167, label: "Greetings from Amsterdam! üá≥üá±" },
            { steps: 731601, label: "Made it to Brussels! üáßüá™" },
            { steps: 751023, label: "Almost there! Paris border! üóº" },
            { steps: 784043, label: "Paris is ours! üá´üá∑‚ù§Ô∏è" },
            { steps: 836859, label: "The Long Walk! üéûÔ∏è" },
            { steps: 954265, label: "Hello Dortmund! üá©üá™" },
            { steps: 1092000, label: "7 days straight walking! üèÖ" },
            { steps: 1145118, label: "From Paris to Berlin! üï∫" },
            { steps: 1259557, label: "John o' Groats to Land's End! üí™" },
            { steps: 1365312, label: "Hello Denmark! üá©üá∞" },
            { steps: 1434914, label: "Reached Berlin! üá©üá™" },
            { steps: 1480427, label: "Hello Norway! üèîÔ∏è" },
            { steps: 1595568, label: "Ciao, Milano! üõçÔ∏è" },
            { steps: 1716000, label: "That's a lot of money! üí∏" },
            { steps: 1761643, label: "Beautiful Barcelona! üá™üá∏" },
            { steps: 1913990, label: "Hello, Firenze! üáÆüáπ" },
            { steps: 2206035, label: "All roads lead to Rome! üáÆüáπ" },
            { steps: 3437785, label: "Greetings from Athens! ‚ú®" },
            { steps: 3766100, label: "One does not simply walk into Mordor... but we did! üë£" },
            { steps: 4469179, label: "Sunshine in Paphos! ‚òÄÔ∏è" },
        ];

        SHARED_STRETCH_GOALS.push({ steps: 1000000, label: "Book Disneyland Paris!", reward: "üè∞üê≠" });
        INDIVIDUAL_STRETCH_GOALS.user1 = [{ steps: 1500000, label: "New Graphics Card!", reward: "üíª" }];
        INDIVIDUAL_STRETCH_GOALS.user2 = [{ steps: 1500000, label: "New Pair of Heels!", reward: "üë†" }];
        // --- End of Customization ---

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyCjvDHVf3-WEwxRXt2oTKyS3U-DrUeMJ4Q",
                authDomain: "a-to-a-walking.firebaseapp.com",
                projectId: "a-to-a-walking",
                storageBucket: "a-to-a-walking.firebasestorage.app",
                messagingSenderId: "482552425657",
                appId: "1:482552425657:web:fbbcc6ef15ca4589ad3f68"
              };
		
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'walking-challenge-app';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let userData = { user1: { name: USER_1_NAME, steps: 0 }, user2: { name: USER_2_NAME, steps: 0 }};
        let logData = [];
        let map = null;
        let markers = null;

        const userSelector = document.getElementById('user-selector');
        const stepForm = document.getElementById('step-form');
        const stepInput = document.getElementById('step-input');
        const feedbackMessage = document.getElementById('feedback-message');
        const stretchGoalsContainer = document.getElementById('stretch-goals-container');
        const user1LogContainer = document.getElementById('user1-log');
        const user2LogContainer = document.getElementById('user2-log');
        const user1HighScoreContainer = document.getElementById('user1-highscore');
        const user2HighScoreContainer = document.getElementById('user2-highscore');
        
        const noteModal = document.getElementById('note-modal');
        const noteForm = document.getElementById('note-form');
        const noteInput = document.getElementById('note-input');
        const noteCancelBtn = document.getElementById('note-cancel');
        
        const locationModal = document.getElementById('location-modal');
        const locationForm = document.getElementById('location-form');
        const locationInput = document.getElementById('location-input');
        const locationCancelBtn = document.getElementById('location-cancel');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        const dateModal = document.getElementById('date-modal');
        const dateForm = document.getElementById('date-form');
        const dateInput = document.getElementById('date-input');
        const dateCancelBtn = document.getElementById('date-cancel');
        
        const statsFilter = document.getElementById('stats-filter');
        const user1AvgSteps = document.getElementById('user1-avg-steps');
        const user2AvgSteps = document.getElementById('user2-avg-steps');
        const user1PredictedSteps = document.getElementById('user1-predicted-steps');
        const user2PredictedSteps = document.getElementById('user2-predicted-steps');
        
        // --- Firestore References ---
        const publicDataCollection = collection(db, 'artifacts', appId, 'public', 'data', 'challengeData');
        const user1DocRef = doc(publicDataCollection, 'user1');
        const user2DocRef = doc(publicDataCollection, 'user2');
        const logsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'challengeLogs');

        // --- Logic ---

        async function initializeUserDocs() {
            try {
                const [user1Doc, user2Doc] = await Promise.all([getDoc(user1DocRef), getDoc(user2DocRef)]);
                if (!user1Doc.exists()) await setDoc(user1DocRef, { name: USER_1_NAME, steps: 0 });
                if (!user2Doc.exists()) await setDoc(user2DocRef, { name: USER_2_NAME, steps: 0 });
            } catch (error) { console.error("Error initializing user documents:", error); }
        }
        
        function getAllGoalsForUser(userKey) {
            const userMilestones = MILESTONES[userKey] || [];
            const userStretchGoals = INDIVIDUAL_STRETCH_GOALS[userKey] || [];
            return [...userMilestones, ...SHARED_STRETCH_GOALS, ...userStretchGoals].sort((a, b) => a.steps - b.steps);
        }

        // --- UI Rendering ---

        function renderProgress(containerId, userKey) {
            const user = userData[userKey];
            const container = document.getElementById(containerId);
            const allUserGoals = getAllGoalsForUser(userKey);
            const nextGoal = allUserGoals.find(g => user.steps < g.steps) || allUserGoals[allUserGoals.length - 1] || { steps: 784043 }; // Fallback to Eiffel Tower
            const displayGoal = nextGoal.steps;
            const progressPercent = displayGoal > 0 ? Math.min((user.steps / displayGoal) * 100, 100) : 0;
            const formattedSteps = user.steps.toLocaleString();
            const formattedDisplayGoal = displayGoal.toLocaleString();
            const fillClass = userKey === 'user1' ? 'progress-bar-fill-ant' : 'progress-bar-fill-amy';
            
            const isAnt = userKey === 'user1';
            const milestoneContainerPosition = isAnt ? 'right-full' : 'left-full';
            const milestoneTextAlign = isAnt ? 'text-right' : 'text-left';

            container.innerHTML = `
                <h3 class="text-2xl font-bold mb-3">${user.name}</h3>
                <div class="relative progress-bar-container flex justify-center">
                    <div class="w-full progress-bar-track rounded-full overflow-hidden relative">
                        <div class="${fillClass} w-full absolute bottom-0" style="height: ${progressPercent}%"></div>
                    </div>
                    <div id="${userKey}-milestones" class="absolute top-0 ${milestoneContainerPosition} w-24 sm:w-32 h-full ${milestoneTextAlign}"></div>
                </div>
                <div class="text-center mt-3">
                    <p class="text-xl font-semibold">${formattedSteps}</p>
                    <p class="text-sm text-gray-500">/ ${formattedDisplayGoal}</p>
                </div>
            `;
            renderMilestones(`${userKey}-milestones`, displayGoal, userKey);
        }

        function renderMilestones(containerId, displayGoal, userKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const allMilestones = getAllGoalsForUser(userKey);
            const isAnt = userKey === 'user1';

            allMilestones.forEach(milestone => {
                const percent = displayGoal > 0 ? (milestone.steps / displayGoal) * 100 : 0;
                if (percent <= 105) {
                    const milestoneEl = document.createElement('div');
                    milestoneEl.className = 'milestone absolute flex items-center w-full';
                    milestoneEl.style.bottom = `calc(${percent}% - 8px)`;
                    
                    if (isAnt) {
                        milestoneEl.style.transform = 'translateX(-10px)';
                        milestoneEl.classList.add('justify-end');
                        milestoneEl.innerHTML = `<span class="milestone-text text-xs text-gray-600 font-medium mr-2">${milestone.label}</span><div class="milestone-line"></div>`;
                    } else {
                        milestoneEl.style.transform = 'translateX(10px)';
                        milestoneEl.innerHTML = `<div class="milestone-line"></div><span class="milestone-text text-xs text-gray-600 font-medium ml-2">${milestone.label}</span>`;
                    }
                    container.appendChild(milestoneEl);
                }
            });
        }

        function renderLogs() {
            user1LogContainer.innerHTML = '';
            user2LogContainer.innerHTML = '';
            
            const sortedLogs = [...logData].sort((a, b) => b.date.toMillis() - a.date.toMillis());

            sortedLogs.forEach(log => {
                const logContainer = log.userId === 'user1' ? user1LogContainer : user2LogContainer;
                const entryEl = document.createElement('div');
                entryEl.className = 'log-entry p-3 border rounded-lg flex justify-between items-start';
                
                const date = log.date.toDate();
                const formattedDate = date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' });
                const isoDate = date.toISOString().split('T')[0];
                const colorClass = log.userId === 'user1' ? 'text-green-600' : 'text-purple-600';
                
                entryEl.innerHTML = `
                    <div class="flex-grow">
                         <div class="flex items-center">
                            <span class="font-bold ${colorClass} mr-2">${log.steps.toLocaleString()}</span>
                            <button type="button" class="edit-date-btn text-sm text-gray-500 cursor-pointer hover:underline" data-log-id="${log.id}" data-date="${isoDate}">
                                ${formattedDate}
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">${log.note || ''}</p>
                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                            ${log.locationName ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${log.locationName}` : ''}
                        </p>
                    </div>
                    <div class="log-actions flex items-center gap-2 ml-2">
                        <button data-log-id="${log.id}" class="edit-location-btn text-gray-500 hover:text-gray-700 p-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${log.id}" data-note="${log.note || ''}" class="edit-note-btn text-blue-500 hover:text-blue-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${log.id}" data-steps="${log.steps}" data-user-id="${log.userId}" class="delete-log-btn text-red-500 hover:text-red-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                logContainer.appendChild(entryEl);
            });
        }
        
        function renderHighScores() {
            user1HighScoreContainer.innerHTML = '';
            user2HighScoreContainer.innerHTML = '';

            ['user1', 'user2'].forEach(userKey => {
                const userLogs = logData.filter(log => log.userId === userKey);
                const container = userKey === 'user1' ? user1HighScoreContainer : user2HighScoreContainer;

                if (userLogs.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 italic">No entries yet.</p>`;
                    return;
                }

                const highScoreLog = userLogs.reduce((max, log) => log.steps > max.steps ? log : max, userLogs[0]);

                const entryEl = document.createElement('div');
                entryEl.className = 'log-entry p-3 border-2 border-amber-400 bg-amber-50 rounded-lg flex justify-between items-start shadow';

                const date = highScoreLog.date.toDate();
                const formattedDate = date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' });
                const isoDate = date.toISOString().split('T')[0];
                const colorClass = highScoreLog.userId === 'user1' ? 'text-green-600' : 'text-purple-600';

                entryEl.innerHTML = `
                    <div class="flex-grow">
                         <div class="flex items-center">
                            <span class="font-bold ${colorClass} text-lg mr-2">${highScoreLog.steps.toLocaleString()} üèÜ</span>
                            <button type="button" class="edit-date-btn text-sm text-gray-500 cursor-pointer hover:underline" data-log-id="${highScoreLog.id}" data-date="${isoDate}">
                                ${formattedDate}
                            </button>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">${highScoreLog.note || ''}</p>
                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                            ${highScoreLog.locationName ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${highScoreLog.locationName}` : ''}
                        </p>
                    </div>
                    <div class="log-actions flex items-center gap-2 ml-2">
                        <button data-log-id="${highScoreLog.id}" class="edit-location-btn text-gray-500 hover:text-gray-700 p-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${highScoreLog.id}" data-note="${highScoreLog.note || ''}" class="edit-note-btn text-blue-500 hover:text-blue-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-log-id="${highScoreLog.id}" data-steps="${highScoreLog.steps}" data-user-id="${highScoreLog.userId}" class="delete-log-btn text-red-500 hover:text-red-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(entryEl);
            });
        }

        function renderStretchGoals() {
            const container = document.getElementById("stretch-goals-container");
            container.innerHTML = "";

            const endDate = new Date('2026-10-01T00:00:00');
            const today = new Date();
            const daysRemaining = Math.max(1, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));

            const bothUsersExist = userData.user1 && userData.user2;

            // Render Shared Goals
            SHARED_STRETCH_GOALS.forEach(goal => {
                const isAchieved = bothUsersExist && userData.user1.steps >= goal.steps && userData.user2.steps >= goal.steps;
                
                const antStepsNeeded = Math.max(0, goal.steps - (userData.user1?.steps || 0));
                const amyStepsNeeded = Math.max(0, goal.steps - (userData.user2?.steps || 0));
                const antDailyAvg = Math.ceil(antStepsNeeded / daysRemaining);
                const amyDailyAvg = Math.ceil(amyStepsNeeded / daysRemaining);

                const dailyAvgHtml = isAchieved ? '' : `
                    <p class="text-xs text-gray-500 mt-1">
                        Daily avg needed: 
                        <span class="font-bold text-green-600">Ant: ${antDailyAvg.toLocaleString()}</span> | 
                        <span class="font-bold text-purple-600">Amy: ${amyDailyAvg.toLocaleString()}</span>
                    </p>`;

                const goalEl = document.createElement("div");
                goalEl.className = `stretch-goal-card bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-gray-300 ${isAchieved ? "achieved bg-amber-50" : ""}`;
                goalEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg ${isAchieved ? "text-amber-700" : "text-gray-800"}">${goal.label} (Shared)</p>
                        <p class="text-sm text-gray-500">${goal.steps.toLocaleString()} steps each</p>
                        ${dailyAvgHtml}
                    </div>
                    <div class="text-3xl">${goal.reward}</div>`;
                container.appendChild(goalEl);
            });

            // Render Individual Goals
            ['user1', 'user2'].forEach(userKey => {
                const user = userData[userKey];
                (INDIVIDUAL_STRETCH_GOALS[userKey] || []).forEach(goal => {
                    if (!user) return;
                    const isAchieved = user.steps >= goal.steps;
                    
                    const stepsNeeded = Math.max(0, goal.steps - user.steps);
                    const dailyAvg = Math.ceil(stepsNeeded / daysRemaining);
                    
                    const colorClass = userKey === 'user1' ? 'text-green-600' : 'text-purple-600';
                    const dailyAvgHtml = isAchieved ? '' : `
                        <p class="text-xs text-gray-500 mt-1">
                            Daily avg needed: <span class="font-bold ${colorClass}">${dailyAvg.toLocaleString()}</span>
                        </p>`;

                    const goalEl = document.createElement("div");
                    goalEl.className = `stretch-goal-card bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-gray-300 ${isAchieved ? "achieved bg-amber-50" : ""}`;
                    goalEl.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg ${isAchieved ? "text-amber-700" : "text-gray-800"}">${goal.label} (${user.name})</p>
                            <p class="text-sm text-gray-500">${goal.steps.toLocaleString()} steps</p>
                            ${dailyAvgHtml}
                        </div>
                        <div class="text-3xl">${goal.reward}</div>`;
                    container.appendChild(goalEl);
                });
            });
        }

        function calculateAndRenderStats() {
            const filterValue = statsFilter.value;
            const today = new Date();
            const challengeStart = new Date('2025-10-01T00:00:00');

            ['user1', 'user2'].forEach(userKey => {
                const userLogs = logData.filter(log => log.userId === userKey);
                let totalSteps = 0;
                let divisor = 1;
                let multiplier = 365; // Default for 'all'
                let averageSteps = 0;

                if (filterValue === 'all') {
                    totalSteps = userData[userKey].steps;
                    const diffTime = Math.max(0, today - challengeStart);
                    divisor = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                } else {
                    const selectedMonth = parseInt(filterValue, 10);
                    const year = selectedMonth >= 9 ? 2025 : 2026;

                    const filteredLogs = userLogs.filter(log => {
                        const logDate = log.date.toDate();
                        return logDate.getMonth() === selectedMonth && logDate.getFullYear() === year;
                    });
                    totalSteps = filteredLogs.reduce((sum, log) => sum + log.steps, 0);

                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();

                    if (selectedMonth === currentMonth && year === currentYear) {
                        divisor = today.getDate();
                    } else {
                        divisor = new Date(year, selectedMonth + 1, 0).getDate();
                    }
                    multiplier = divisor; // For monthly, multiplier is just the number of days in that month
                }
                
                divisor = Math.max(1, divisor); // Prevent division by zero
                averageSteps = totalSteps / divisor;
                const predictedSteps = averageSteps * multiplier;

                const avgTarget = userKey === 'user1' ? user1AvgSteps : user2AvgSteps;
                const predictedTarget = userKey === 'user1' ? user1PredictedSteps : user2PredictedSteps;
                
                avgTarget.textContent = Math.round(averageSteps).toLocaleString();
                predictedTarget.textContent = Math.round(predictedSteps).toLocaleString();
            });
        }
        
        function renderMap() {
            if (!map || !markers) return;
            markers.clearLayers();

            logData.forEach(log => {
                if(log.lat && log.lng) {
                    const isAnt = log.userId === 'user1';
                    const color = isAnt ? '#22c55e' : '#9333ea';
                    
                    const svgIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="${color}">
                            <path d="M12 0C7.589 0 4 3.589 4 8c0 4.411 8 16 8 16s8-11.589 8-16c0-4.411-3.589-8-8-8zm0 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                        </svg>`;

                    const customIcon = L.divIcon({
                        html: svgIcon,
                        className: '',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });

                    const marker = L.marker([log.lat, log.lng], { icon: customIcon });
                    
                    const popupContent = `
                        <div class="text-base">
                            <p class="font-bold">${isAnt ? USER_1_NAME : USER_2_NAME}</p>
                            <p><span class="font-semibold">${log.steps.toLocaleString()}</span> steps</p>
                            <p class="text-sm text-gray-600">${log.date.toDate().toLocaleDateString()}</p>
                            ${log.note ? `<p class="mt-1 italic">"${log.note}"</p>` : ''}
                        </div>`;
                    
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                }
            });
        }

        function updateUI() {
            if (!userData.user1 || !userData.user2) return;
            renderProgress('user1-progress', 'user1');
            renderProgress('user2-progress', 'user2');
            renderStretchGoals();
            renderHighScores();
            renderLogs();
            calculateAndRenderStats();
            renderMap();
            setTimeout(() => document.querySelectorAll('.milestone').forEach(m => m.classList.add('visible')), 100);
        }

        // --- Event Handlers ---
        
        function setupUserSelector() {
            ['user1', 'user2'].forEach(userKey => {
                const button = document.createElement('button');
                button.dataset.user = userKey;
                button.textContent = userData[userKey].name;
                button.className = "px-6 py-2 text-lg font-semibold border-2 border-transparent rounded-lg transition bg-gray-200";
                userSelector.appendChild(button);
            });

            userSelector.addEventListener("click", e => {
                if (e.target.tagName !== 'BUTTON') return;

                currentUser = e.target.dataset.user;
                const isAnt = currentUser === 'user1';
                
                Array.from(userSelector.children).forEach(button => {
                    const isSelected = button.dataset.user === currentUser;
                    button.classList.remove('bg-green-500', 'bg-purple-500', 'text-white', 'bg-gray-200');
                    if (isSelected) {
                        button.classList.add(isAnt ? 'bg-green-500' : 'bg-purple-500', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200');
                    }
                });
                
                const formButton = stepForm.querySelector('button[type="submit"]');
                formButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-purple-500', 'hover:bg-purple-600');
                stepInput.classList.remove('focus:ring-2', 'focus:ring-green-500', 'focus:ring-purple-500');
                
                if (isAnt) {
                    formButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-green-500');
                } else {
                    formButton.classList.add('bg-purple-500', 'hover:bg-purple-600');
                    stepInput.classList.add('focus:ring-2', 'focus:ring-purple-500');
                }

                stepForm.classList.remove("hidden");
                stepInput.focus();
            });
        }
        
        async function handleStepSubmit(e) {
            e.preventDefault();
            if (!currentUser) return;
            const steps = parseInt(stepInput.value, 10);
            if (isNaN(steps) || steps <= 0) return;
            
            stepInput.disabled = true;
            feedbackMessage.textContent = 'Saving...';
            
            const userDocRef = currentUser === 'user1' ? user1DocRef : user2DocRef;
            const oldTotal = userData[currentUser].steps;

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists()) { throw "Document does not exist!"; }
                    const newTotal = userDoc.data().steps + steps;
                    transaction.update(userDocRef, { steps: newTotal });
                    transaction.set(doc(logsCollectionRef), {
                        userId: currentUser,
                        steps: steps,
                        note: "",
                        date: Timestamp.now(),
                        locationName: null,
                        lat: null,
                        lng: null
                    });
                });

                stepForm.reset();
                feedbackMessage.textContent = `Added ${steps.toLocaleString()} steps!`;
                
                const allUserGoals = getAllGoalsForUser(currentUser);
                if (allUserGoals.find(g => oldTotal < g.steps && (oldTotal + steps) >= g.steps)) {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }
            } catch (error) {
                console.error("Error adding steps:", error);
                feedbackMessage.textContent = 'Error saving. Please try again.';
            } finally {
                stepInput.disabled = false;
                setTimeout(() => feedbackMessage.textContent = '', 3000);
            }
        }
        
        function setupStatsFilter() {
            const challengeMonths = [
                { name: 'Oct', value: 9 }, { name: 'Nov', value: 10 }, { name: 'Dec', value: 11 },
                { name: 'Jan', value: 0 }, { name: 'Feb', value: 1 }, { name: 'Mar', value: 2 },
                { name: 'Apr', value: 3 }, { name: 'May', value: 4 }, { name: 'Jun', value: 5 },
                { name: 'Jul', value: 6 }, { name: 'Aug', value: 7 }, { name: 'Sep', value: 8 }
            ];

            let options = '<option value="all">All</option>';
            options += challengeMonths.map(m => `<option value="${m.value}">${m.name}</option>`).join('');
            statsFilter.innerHTML = options;

            statsFilter.addEventListener('change', updateUI);
        }

        // --- Modal Handlers ---
        let confirmCallback = null;
        function showConfirmModal(message, onConfirm) {
            confirmModalText.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        confirmCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });
        
        let currentLogIdForNote = null;
        function handleOpenNoteModal(e) {
            const button = e.target.closest('.edit-note-btn');
            if (button) {
                currentLogIdForNote = button.dataset.logId;
                noteInput.value = button.dataset.note;
                noteModal.classList.remove('hidden');
                noteInput.focus();
            }
        }
        noteCancelBtn.addEventListener('click', () => noteModal.classList.add('hidden'));
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForNote) return;
            const logDocRef = doc(logsCollectionRef, currentLogIdForNote);
            await updateDoc(logDocRef, { note: noteInput.value });
            noteModal.classList.add('hidden');
            currentLogIdForNote = null;
        });

        let currentLogIdForDate = null;
        function handleOpenDateModal(e) {
            const button = e.target.closest('.edit-date-btn');
            if (button) {
                currentLogIdForDate = button.dataset.logId;
                dateInput.value = button.dataset.date;
                dateModal.classList.remove('hidden');
            }
        }

        dateCancelBtn.addEventListener('click', () => {
            dateModal.classList.add('hidden');
            currentLogIdForDate = null;
        });

        dateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForDate || !dateInput.value) return;
            
            const logDocRef = doc(logsCollectionRef, currentLogIdForDate);
            const newDate = new Date(dateInput.value + "T12:00:00");
            
            try {
                await updateDoc(logDocRef, { date: Timestamp.fromDate(newDate) });
            } catch (error) {
                console.error("Error updating date:", error);
                feedbackMessage.textContent = 'Failed to update date.';
                setTimeout(() => { feedbackMessage.textContent = '' }, 3000);
            } finally {
                dateModal.classList.add('hidden');
                currentLogIdForDate = null;
            }
        });

        let currentLogIdForLocation = null;
        function handleOpenLocationModal(e) {
            const button = e.target.closest('.edit-location-btn');
            if (button) {
                currentLogIdForLocation = button.dataset.logId;
                locationInput.value = '';
                locationModal.classList.remove('hidden');
                locationInput.focus();
            }
        }
        locationCancelBtn.addEventListener('click', () => locationModal.classList.add('hidden'));
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentLogIdForLocation) return;
            const locationText = locationInput.value.trim();
            if (!locationText) return;

            const button = locationForm.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Searching...';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationText)}&format=json&limit=1`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    const logDocRef = doc(logsCollectionRef, currentLogIdForLocation);
                    await updateDoc(logDocRef, {
                        locationName: display_name,
                        lat: parseFloat(lat),
                        lng: parseFloat(lon)
                    });
                    locationModal.classList.add('hidden');
                } else {
                    alert('Location not found. Please try being more specific.');
                }
            } catch (error) {
                console.error("Error geocoding:", error);
                alert('Could not find location. Please check your connection and try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Search & Save';
            }
        });

        // --- Log Action Handlers (Delegated) ---
        async function handleDeleteLog(e) {
            const button = e.target.closest('.delete-log-btn');
            if (button) {
                const { logId, steps, userId } = button.dataset;
                const stepsToDeduct = parseInt(steps, 10);

                const onConfirm = async () => {
                    const logDocRef = doc(logsCollectionRef, logId);
                    const userDocRef = userId === 'user1' ? user1DocRef : user2DocRef;
                    try {
                        await runTransaction(db, async (transaction) => {
                             const userDoc = await transaction.get(userDocRef);
                             if (!userDoc.exists()) { throw "User document not found"; }
                             const newTotal = Math.max(0, userDoc.data().steps - stepsToDeduct);
                             transaction.update(userDocRef, { steps: newTotal });
                             transaction.delete(logDocRef);
                        });
                    } catch (error) {
                        console.error("Error deleting log entry:", error);
                        feedbackMessage.textContent = 'Failed to delete entry.';
                        setTimeout(() => { feedbackMessage.textContent = '' }, 3000);
                    }
                };
                
                showConfirmModal(`Are you sure you want to delete this log of ${stepsToDeduct.toLocaleString()} steps? This cannot be undone.`, onConfirm);
            }
        }
        
        document.addEventListener('click', (e) => {
            handleOpenNoteModal(e);
            handleDeleteLog(e);
            handleOpenDateModal(e);
            handleOpenLocationModal(e);
        });

        // Initialisation
        function initializeMap() {
            map = L.map('map').setView([54.5, -2.5], 6); // Centered on the UK
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markers = L.layerGroup().addTo(map);
        }

        async function main() {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Authentication failed", e); }
            
            await initializeUserDocs();
            initializeMap();
            setupUserSelector();
            setupStatsFilter();
            stepForm.addEventListener('submit', handleStepSubmit);

            // --- Real-time Listeners ---
            onSnapshot(user1DocRef, (doc) => {
                if(doc.exists()) userData.user1 = { ...userData.user1, ...doc.data() };
                updateUI();
            });
            onSnapshot(user2DocRef, (doc) => {
                if(doc.exists()) userData.user2 = { ...userData.user2, ...doc.data() };
                updateUI();
            });
            const logsQuery = query(logsCollectionRef, orderBy("date", "desc"));
            onSnapshot(logsQuery, (snapshot) => {
                logData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
        }

        main();

    </script>
</body>
</html>
